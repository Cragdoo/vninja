<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Fun and Games with VDR and Snapshots  &middot; vNinja.net</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="Datastore, Snapshot, VDR, VMware, vSphere, ">

<link rel="author" href="http://plus.google.com/+Myprofile">


<meta property="og:title" content="Fun and Games with VDR and Snapshots  &middot; vNinja.net ">
<meta property="og:site_name" content="vNinja.net"/>
<meta property="og:url" content="https://vninja.net/virtualization/fun-games-vdr-snapshots/" />
<meta property="og:locale" content="en">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2013-01-10T13:47:50Z" />
<meta property="og:article:modified_time" content="2013-01-10T13:47:50Z" />

  
    
<meta property="og:article:tag" content="Datastore">
    
<meta property="og:article:tag" content="Snapshot">
    
<meta property="og:article:tag" content="VDR">
    
<meta property="og:article:tag" content="VMware">
    
<meta property="og:article:tag" content="vSphere">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@h0bbel" />
<meta name="twitter:creator" content="@h0bbel" />
<meta name="twitter:title" content="Fun and Games with VDR and Snapshots" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://vninja.net/virtualization/fun-games-vdr-snapshots/" />
<meta name="twitter:domain" content="https://vninja.net">
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Fun and Games with VDR and Snapshots",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+Myprofile?rel=author"
    },
    "datePublished": "2013-01-10",
    "description": "",
    "wordCount": 599
  }
</script>
  



<link rel="canonical" href="https://vninja.net/virtualization/fun-games-vdr-snapshots/" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://vninja.net/touch-icon-144-precomposed.png">
<link rel="icon" href="https://vninja.net/favicon.png">
<meta name="generator" content="Hugo 0.42.2" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="https://vninja.net/css/bootswatch/yeti/bootstrap.min.css">


<link rel="stylesheet" href="https://vninja.net/css/font-awesome.min.css">
<link rel="stylesheet" href="https://vninja.net/css/style.css">


<link rel="stylesheet" href="https://vninja.net/css/style_custom.css">



  <link rel="stylesheet" href="https://vninja.net/css/highlight/default.css">


  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
  <script>
  window.addEventListener("load", function(){
  window.cookieconsent.initialise({
    "palette": {
      "popup": {
        "background": "#efefef",
        "text": "#404040"
      },
      "button": {
        "background": "#8ec760",
        "text": "#ffffff"
      }
    },
    "showLink": false,
    "position": "bottom-right"
  })});
  </script>
</script>




</head>
<body data-ng-app="myapp" data-ng-controller="MyController" data-ng-mouseleave="MouseLeave($event)">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        
        <a class="navbar-brand" href="https://vninja.net/">
          vNinja.net
          
          
          </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            
            
            <li class="">
              
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class='fa fa-bars'></i> About <span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    
                      <li class="">
                        <a href="https://vninja.net/about/christian-mohn/"><i class='fa fa-child'></i> About Christian</a>
                      </li>
                    
                  </ul>
              
            </li>
            
            <li class="">
              
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class='fa fa-asterisk'></i> Site Policy <span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    
                      <li class="">
                        <a href="https://vninja.net/about/privacy-policy"><i class='fa fa-asterisk'></i> Privacy Policy</a>
                      </li>
                    
                  </ul>
              
            </li>
            
            <li class="">
              
                <a href="https://vninja.net/advertising" >
                  <i class='fa fa-bank'></i>
                  Advertising
                </a>
              
            </li>
            
            <li class="">
              
                <a href="https://vninja.net/post/index.xml" >
                  <i class='fa fa-rss'></i>
                  RSS
                </a>
              
            </li>
            
            
              
          </ul>
        </div>
        
      </div>
    </nav>
  </header>





<div class="container">
  <div class="row">
    <div class="col-sm-9">


      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <div class="title-metas text-center">

    <h1>Fun and Games with VDR and Snapshots
</h1>

    <div class="metas">
<small>
  <i class="fa fa-calendar"></i>
  <time datetime="2013-01-10">10 Jan, 2013</time>
</small>


  <small>
    &middot; by Christian Mohn
  
  &middot; Read in about 3 min
  &middot; (599 words)
  &middot; 


  </small>

<div class="margin-10">
  <i class="fa fa-tags"></i>
  
  <a href="https://vninja.net/tags/datastore" class="label label-primary">Datastore</a>
  
  <a href="https://vninja.net/tags/snapshot" class="label label-primary">Snapshot</a>
  
  <a href="https://vninja.net/tags/vdr" class="label label-primary">VDR</a>
  
  <a href="https://vninja.net/tags/vmware" class="label label-primary">VMware</a>
  
  <a href="https://vninja.net/tags/vsphere" class="label label-primary">vSphere</a>
  


</div>

<br>
</div>

  </div>
</div>


      <div class="content">

  

  <p>One of the smaller improvements in vSphere 5 was the introduction of the <strong>&laquo;Virtual machine disks consolidation is needed&raquo;</strong> configuration alert if vSphere determines that there are orphaned snapshots for a given VM.</p>

<p><a href="https://vninja.net/img/Consolidation.png"><img src="https://vninja.net/img/Consolidation.png" alt="Consolidation Needed Warning" /></a></p>

<p>Previous versions does not show this warning message, and datastore usage could potentially skyrocket for no apparent reason if something continues to create snapshots that are not properly cleaned up when they are no longer in use. Unless there is active space monitoring for your datastores, <em>and there should be</em>, it could go on unnoticed for some time.</p>

<p>Running a snapshot consolidation attempts to clean up this situation, and remove the orphaned snapshots reclaiming the space they occupy.</p>

<p><strong>This video from VMware shows how this is done, and how it should work:</strong></p>

<p>For more info, have a look at <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2003638">KB2003638 Consolidating snapshots in vSphere 5.x</a></p>

<p>While it is great that you get alerted when this happens, and that there is an option to clean it up directly in the vSphere Client, what do you do if consolidation doesn´t work for some reason?</p>

<p>I recently visited a client who had problems with their <a href="http://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.datarecovery.admin.doc_20%2FGUID-94DB0284-9D58-4FDF-8A88-847E59982AAE.html">VDR appliance</a>, and every attempted backup left orphaned snapshots behind. By default VDR has a retry interval of 30 minutes for failed backups (<em>BackupRetryInterval=30 in datarecovery.ini</em>), before it times out. In the space of 30 minutes, VDR did 30 backup attempts, effectively creating 30 orphaned snapshots each time a backup was attempted. One of the affected VMs had over 300 delta files accumulated over a fairly small timeframe.</p>

<p>There clearly were a lot of snapshots in the datastore, but for some reason the vSphere Client Snapshot Manager did not show any snapshots for the VM. Clearly there was an inconsistency here, and after investigating the <em>VM.vmsd</em> file it became fairly apparent what was going on. The <em>VM.vmsd</em> file is responsible for keeping tabs of the snapshot delta-vmdk files and is the source that the Snapshot Manager uses to display and manage them.</p>

<p>The case here was that when a snapshot is removed, the snapshot entity in the <em>VM.vmsd</em> is removed before the changes are made to the child disks. When VDR subsequently had problems removing the child disks, they were being left behind.</p>

<p>Combine this situation with the fact that the <em>maximum redo logs supported is 255</em>, you can quickly run into a situation where there are snapshots left behind that you can´t get easily rid of with the consolidate command.</p>

<p>Cloning the VM was not really an option, since a clone operation actually consolidates snapshots as part of the cloning process, it would also fail with the same error.</p>

<p><em>In the end, the solution was to fire up VMware vCenter Converter, and use that to perform a V2V &laquo;conversion&raquo; of the VMs. Why does this work, when a &laquo;native&raquo; vSphere clone operation does not? The answer is surprisingly simple, vCenter Converter does not know the virtual disk structure at all. It sees only that what the operating system sees, and the OS inside the VM has no concept or knowledge of the snapshots created in vCenter.</em></p>

<p>While this fixed the immediate issue of getting rid of the orphaned snapshots and reclaim the space wasted by them, it does not fix the underlying root issue that causes VDR not to clean up after itself.</p>

<p>For some reason it looks like VDR, after mounting the snapshot files to the appliance, does not release them, thus retaining a lock on the snapshot files, This in turn means that the <em>VM.vmsd</em> file is cleared for VDR snapshots, but the files are still present on on the datastore.</p>

</div>


      <footer>
  


  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      
  
    <nav><ul class="pager">
    
        <li class="previous">
          <a href="https://vninja.net/vmware-2/vmware-hands-on-lab-online-review/" title="VMware Hands-on Lab Online Public Beta Review">
            <span aria-hidden="true">&larr;</span>Previous
          </a>
        </li>
    

    
      <li class="next">
        <a href="https://vninja.net/virtualization/vmware-workstation-license/" title="Want a VMware Workstation License?">
            Next <span aria-hidden="true">&rarr;</span>
        </a>
      </li>
    
    </ul> </nav>
  


</div>

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  

</div>

</footer>

    </div>
    
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <div>
  

    <div class="section">
      <h4>Sponsors</h4>
      <div class="ads" id="veeam">
        <ins class='dcmads' style='display:inline-block;width:250px;height:250px' data-dcm-placement='N410401.1772869VNINJA.NET/B10464038.145283149' data-dcm-rendering-mode='iframe' data-dcm-https-only data-dcm-resettable-device-id='' data-dcm-app-id=''> <script src='https://www.googletagservices.com/dcm/dcmads.js'></script> </ins>
      </div>
      <div class="ads" id="turbonomic">
        <a href="http://turbonomic.com/resources/hybrid-cloud-intelligent-bursting-aws-microsoft-azure/?utm_source=vninja&amp;utm_medium=banner-ad&amp;utm_campaign=wp-path-to-hybrid-cloud&amp;">
          <img width="250" height="250" src="https://vninja.net/ads/wp-intelligent-bursting-aws-azure-250x250.png"></a>
      </div>
      <div class="ads" id="goliath">
        <a href="http://goliathtechnologies.com/performance-monitoring/application-desktop-virtualization/vmware-horizon-view-monitoring/?utm_source=VNINJA&#038;utm_medium=PARTNER-MKTG&#038;utm_campaign=PARTNER-MKTG-VNINJA"><img width="250" height="250" src='https://vninja.net/ads/VMwareHorizon.jpg' alt='' title='VMwareHorizon' /></a>
      </div>
      <div class="ads" id="vembu">
        <a href="https://www.vembu.com/free-vm-backup/?utm_source=vninja.net&#038;utm_medium=Banner"><img width="250" height="250" src='https://vninja.net/ads/vembu250-250.gif'/></a>
      </div>


    </div>

    <hr>
    
      
      
      <div class="section">


      </div>
      
    
      
      
      <div class="section">


      </div>
      
    

</div>

      </div>
    
  </div>
</div>
    
<footer class="footer hidden-print">
  <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="javascript:" id="return-to-top">back to top</a>
</div>
<div class="pull-right">

<a href="https://vninja.net/disclaimer/">Disclaimer</a> <i>&middot;</i>

</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
              
    
<div class="container footline">
    <small>
  Built with Hugo and lots of <i class='fa fa-coffee'></i>

</small>
</div>


    
<div class="container copyright">
    <small>
  &copy; 2018 Christian Mohn

  </small>
</div>




        </div>
    </div>
  </div>
</footer>

    

<script src="https://vninja.net/js/jquery.min.js"></script>
<script src="https://vninja.net/js/bootstrap.min.js"></script>


<script src="https://vninja.net/js/highlight.pack.js"></script>
<script src="https://vninja.net/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
  var _gaq=[['_setAccount','UA-121910549-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<script>
var ENABLE_POPOVER = "", 
EXPIRE_COOKIE = "", 
SHOW_MODAL_TIMEOUT = "", 
MOUSE_LEAVE = "", 
MODAL_SIZE = "", 
POST_URL = "", 
SIGNUP_HEADER = "",
HEADER_IMAGE = "",
IMG_DESCRIPTION = "",
SIGNUP_TEXT = "",
INPUT_PLACEHOLDER = "",
SUBMIT_BUTTON = "",
SUCCESS_MESSAGE = "",
ERROR_MESSAGE = "",
OPTIN = "",
COOKIE_NAME = "",
CONTENTLANGUAGE = ""; 
</script>










  </body>
</html>

