<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Why Did the HP BL460c G8 Lose It&#39;s Datastore?  &middot; Adventures in Hugo</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="There is a thin line between agile and fragile" />

<meta name="keywords" content="BL460c, c3000, c7000, ESXi, G8, HP, P220i, Patch, ProLiant, Update, VMware, ">


<meta property="og:title" content="Why Did the HP BL460c G8 Lose It&#39;s Datastore?  &middot; Adventures in Hugo ">
<meta property="og:site_name" content="Adventures in Hugo"/>
<meta property="og:url" content="/vmware-2/hp-bl460c-g8-lose-its-datastore/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2012-10-29T21:48:08Z" />
<meta property="og:article:modified_time" content="2012-10-29T21:48:08Z" />

  
    
<meta property="og:article:tag" content="BL460c">
    
<meta property="og:article:tag" content="c3000">
    
<meta property="og:article:tag" content="c7000">
    
<meta property="og:article:tag" content="ESXi">
    
<meta property="og:article:tag" content="G8">
    
<meta property="og:article:tag" content="HP">
    
<meta property="og:article:tag" content="P220i">
    
<meta property="og:article:tag" content="Patch">
    
<meta property="og:article:tag" content="ProLiant">
    
<meta property="og:article:tag" content="Update">
    
<meta property="og:article:tag" content="VMware">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Why Did the HP BL460c G8 Lose It&#39;s Datastore?" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="/vmware-2/hp-bl460c-g8-lose-its-datastore/" />
<meta name="twitter:domain" content="/">
  

  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Why Did the HP BL460c G8 Lose It&#39;s Datastore?",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2012-10-29",
    "description": "",
    "wordCount": 896
  }
</script>
  



<link rel="canonical" href="/vmware-2/hp-bl460c-g8-lose-its-datastore/" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
<link rel="icon" href="/favicon.png">
<meta name="generator" content="Hugo 0.40.3" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="/css/bootswatch/default/bootstrap.min.css">


<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">




  <link rel="stylesheet" href="/css/highlight/default.css">


</head>
<body data-ng-app="myapp" data-ng-controller="MyController" data-ng-mouseleave="MouseLeave($event)">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        
          
          <a class="navbar-brand-img" href="/">
            <img alt="" src="">
            
          </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            
            
            
              
          </ul>
        </div>
        
      </div>
    </nav>
  </header>





<div class="container">
  <div class="row">
    <div class="col-sm-12">


      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" >
<header class="container hat">
  <h1>Why Did the HP BL460c G8 Lose It&#39;s Datastore?
</h1>

</header>
</div>


      <div class="content">
  <p>Post Update:
As per <a href="http://vcp5.wordpress.com">Preetam´s</a> <a href="http://vninja.net/vmware-2/hp-bl460c-g8-lose-its-datastore/#comment-12163">comment</a>, HP has published a <a href="http://h20000.www2.hp.com/bizsupport/TechSupport/Document.jsp?objectID=c03603069&amp;jumpid=em_alerts_us-us_Dec12_xbu_all_all_1990986_137282_proliantserversbladesystem_critical_006_0">customer advisory regarding the usage of install vs update</a>.</p>

<p><img src="http://vninja.net/wordpress/wp-content/uploads/2012/10/IMG_3814-2-300x225.jpg" alt="HP BL 460c G8" /></p>

<p>After installing a couple of brand new <strong>HP ProLiant BL460c G8</strong> blades with <strong>HP Smart Array P220i</strong> controllers at a customer site, I decided that I should upgrade from the <a href="https://my.vmware.com/web/vmware/details?downloadGroup=HP-ESXI-5.0.0-U1-15MAR2012&amp;productId=229">VMware-ESXi-5.0.0-Update1-623860-HP-5.20.43.iso</a> Build <em>623860</em> used to install the blades, to the latest <em>821926</em> <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2032584">build offered by VMware</a>.</p>

<p>Normally this is a really easy process using VMware Update Manager, but since this is a new installation all the prerequisites for that are not in place just yet and I decided to use <em>esxcli</em> to perform the update.</p>

<p>After placing the downloaded <em>ESXi500-201209001.zip</em> VIB file on the local datastore on the first host, I ran the update with the following command: (abbreviated for legibility)</p>

<p>[cc lang=&ldquo;bash&rdquo; width=&ldquo;95%&rdquo; theme=&ldquo;blackboard&rdquo; nowrap=&ldquo;0&rdquo;]
~ # esxcli software vib install -d /vmfs/volumes/datastore1/ESXi500-201209001.zip
Installation Result
Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.
Reboot Required: true
VIBs Installed: [&hellip;]
VIBs Removed: [&hellip;]
~ #
[/cc]</p>

<p>So far so good! One quick, as quick as a HP blade can, reboot later my host was updated to <em>ESXi 5.0.0 Build 821926</em> and everything looked fine. That is, until I wanted to put some new files into the blades local storage. Much to my surprise, there was no local storage to be seen at all. Thinking that something must have gone wrong while booting, I decided to try a new restart and imagine my surprise when the blade booted up again, but this time with <em>Build 623860</em>.</p>

<p>Thinking that I must have messed things up pretty badly, I decided to try the same procedure on the second HP ProLiant BL460c G8 blade installed in the same manner. And yet again, I got the same results.</p>

<p>While this is somewhat comforting when contemplating Albert Einstein´s <a href="http://www.brainyquote.com/quotes/quotes/a/alberteins133991.html">definition of insanity</a>, it´s not comforting when it comes to the procedure I followed for updating the hosts.</p>

<p>This time around I recorded the output the <em>esxcli</em> command gave me, and found this little gem hidden inside the output:(unrelated VIBs removed)</p>

<p>[cc lang=&ldquo;bash&rdquo; width=&ldquo;95%&rdquo; theme=&ldquo;blackboard&rdquo; nowrap=&ldquo;0&rdquo;]
~ # esxcli software vib install -d /vmfs/volumes/esx5local/ESXi500-201209001.zip
Installation Result
Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.
Reboot Required: true
VIBs Installed: [&hellip;], VMware_bootbank_scsi-hpsa_5.0.0-17vmw.500.0.0.469512, [&hellip;]
VIBs Removed: [&hellip;], Hewlett-Packard_bootbank_scsi-hpsa_5.0.0-28OEM.500.0.0.472560, [&hellip;]
~ #
[/cc]</p>

<p>So, in short the update from VMware removes the HP Bootbank VIB for local SCSI controllers, and replaces it with a VMware one. Effectively this removes the ESXi hosts ability to read the local datastore from the <strong>HP Smart Array P220i Controller</strong>.</p>

<p><strong>What still baffles me though, is that the first boot after applying the update boots <em>Build 821926</em>, but subsequent boots are on <em>Build 623860</em>&hellip;</strong></p>

<p>In the end, to rectify the issue, I found the <a href="http://h20565.www2.hp.com/portal/site/hpsc/template.PAGE/public/psi/swdDetails/?sp4ts.oid=5177950&amp;spf_p.tpst=swdMain&amp;spf_p.prp_swdMain=wsrp-navigationalState%3Didx%253D%257CswItem%253DMTX_c169c54cc80d4c1c8515b79d21%257CswEnvOID%253D4115%257CitemLocale%253D%257CswLang%253D%257Cmode%253D%257Caction%253DdriverDocument&amp;javax.portlet.begCacheTok=com.vignette.cachetoken&amp;javax.portlet.endCacheTok=com.vignette.cachetoken">scsi-hpsa-5.0.0-28OEM.500.0.0.472560.x86_64.vib</a> file on hp.com, downloaded it and placed it on the host.</p>

<p>I then ran the update again
[cc lang=&ldquo;bash&rdquo; width=&ldquo;95%&rdquo; theme=&ldquo;blackboard&rdquo; nowrap=&ldquo;0&rdquo;]
~ # esxcli software vib install -d /vmfs/volumes/datastore1/ESXi500-201209001.zip
Installation Result
Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.
Reboot Required: true
VIBs Installed: [&hellip;]
~ #
[/cc]</p>

<p>After installing the update, I then installed the <strong>HP ProLiant Smart Array Controller Driver</strong>
[cc lang=&ldquo;bash&rdquo; width=&ldquo;95%&rdquo; theme=&ldquo;blackboard&rdquo; nowrap=&ldquo;0&rdquo;]
~ # esxcli software vib install -v file:/tmp/scsi-hpsa-5.0.0-28OEM.500.0.0.472560.x86_64.vib
Installation Result
Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.
Reboot Required: true
VIBs Installed: Hewlett-Packard_bootbank_scsi-hpsa_5.0.0-28OEM.500.0.0.472560
VIBs Removed: VMware_bootbank_scsi-hpsa_5.0.0-17vmw.500.0.0.469512
VIBs Skipped:
~ #
[/cc]</p>

<p>This reverses the removal of the _Hewlett-Packard_bootbank_scsi-hpsa<em>5.0.0-28OEM.500.0.0.472560</em> VIB by the VMware Update itself.</p>

<p>Another (quick) reboot, and finally my host was upgraded to the correct build and the local datastore was available too.</p>

<p>[cc lang=&ldquo;bash&rdquo; width=&ldquo;95%&rdquo; theme=&ldquo;blackboard&rdquo; nowrap=&ldquo;0&rdquo;]
~ # cat /proc/driver/hpsa/hpsa0
hpsa0: HP Smart Array P220i Controller
Board ID: 0x3355103c
Firmware Version: 3.04
Driver Version: HP HPSA Driver (v 5.0.0-28OEM)
Driver Build: 2
IRQ: 217
Logical drives: 1
Current Q depth: 0
Current # commands on controller: 0
Max Q depth since init: 0
Max # commands on controller since init: 4
Max SG entries since init: 129
Max Commands supported: 1020
SCSI host number: 0</p>

<p>hpsa0/C0:B0:T0:L1 Direct-Access LOGICAL VOLUME 3.04 RAID 1(1+0)
~ #
[/cc]</p>

<p>Thankfully these blades had not yet been put into production, and I was free to wrestle with them as much as I wanted to make this work, without it affecting anything other than my troubleshooting genes.</p>

<p>I have not tested if the same scenario unfolds if the hosts are updated via VMware Update Manager, but I suspect that the results would have been the same.</p>

<p>Of course, the hosts could have been installed with the newer <a href="https://my.vmware.com/web/vmware/details?downloadGroup=HP-ESXI-5.0.0-U1-15MAR2012_V2&amp;productId=229">HP ESXi 5.0 U1 Sept 2012 refresh</a> in the first place, and I probably would not have run into this issue, at least not until someone decided to apply a later patch to the host.</p>

<p>All in all, I guess the lesson here is that you need to be careful when updating your hosts and make sure you have a real retreat option ready if you need to quickly roll back to the previous build. The luxury of having the time and possibility to really troubleshoot the issue, might not be available to you if you are upgrading production systems.</p>

<p><em>Test your updates, every time.</em></p>

</div>


      
    </div>
    
  </div>
</div>
    
<footer class="footer hidden-print">
  <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="javascript:" id="return-to-top">back to top</a>
</div>
<div class="pull-right">

</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
              
    
<div class="container footline">
    <small>
</small>
</div>


    
<div class="container copyright">
    <small>
  &copy; Christian Mohn

  </small>
</div>



        </div>
    </div>
  </div>
</footer>

    

<script src="//s3.amazonaws.com/mailmunch/static/site.js" id="mailmunch-script" data-mailmunch-site-id="" async="async"></script>



<script src="//load.sumome.com/" data-sumo-site-id="" async="async"></script>

<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>


<script src="/js/highlight.pack.js"></script>
<script src="/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
var ENABLE_POPOVER = "", 
EXPIRE_COOKIE = "", 
SHOW_MODAL_TIMEOUT = "", 
MOUSE_LEAVE = "", 
MODAL_SIZE = "", 
POST_URL = "", 
SIGNUP_HEADER = "",
HEADER_IMAGE = "",
IMG_DESCRIPTION = "",
SIGNUP_TEXT = "",
INPUT_PLACEHOLDER = "",
SUBMIT_BUTTON = "",
SUCCESS_MESSAGE = "",
ERROR_MESSAGE = "",
OPTIN = "",
COOKIE_NAME = "",
CONTENTLANGUAGE = ""; 
</script>





<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax//MathJax.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax//config/TeX-AMS-MML_HTMLorMML.js"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    for(var all in MathJax.Hub.getAllJax()) {
        all.SourceElement().parentNode.className += ' has-jax';

    }
});
</script>






  </body>
</html>

