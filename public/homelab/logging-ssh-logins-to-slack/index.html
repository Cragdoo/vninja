<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Logging SSH logins to Slack  &middot; My blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="Awesome, Homelab, HomeLabOps, Slack, ">


<meta property="og:title" content="Logging SSH logins to Slack  &middot; My blog ">
<meta property="og:site_name" content="My blog"/>
<meta property="og:url" content="/homelab/logging-ssh-logins-to-slack/" />
<meta property="og:locale" content="en">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2016-10-06T11:31:51Z" />
<meta property="og:article:modified_time" content="2016-10-06T11:31:51Z" />

  
    
<meta property="og:article:tag" content="Awesome">
    
<meta property="og:article:tag" content="Homelab">
    
<meta property="og:article:tag" content="HomeLabOps">
    
<meta property="og:article:tag" content="Slack">
    
  

  

  



<link rel="canonical" href="/homelab/logging-ssh-logins-to-slack/" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
<link rel="icon" href="/favicon.png">
<meta name="generator" content="Hugo 0.40.3" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="/css/bootswatch/paper/bootstrap.min.css">


<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">




  <link rel="stylesheet" href="/css/highlight/default.css">


</head>
<body data-ng-app="myapp" data-ng-controller="MyController" data-ng-mouseleave="MouseLeave($event)">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        
          
          <a class="navbar-brand-img" href="/">
            <img alt="Appernetic blog" src="http://blog.appernetic.io/images/apperneticlogo.png">
            
          </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            
            
            <li class="">
              
                <a href="https://appernetic.io/app/#/about" >
                  <i class='fa fa-road'></i>
                  About
                </a>
              
            </li>
            
            <li class="">
              
                <a href="/post/" >
                  
                  Blog
                </a>
              
            </li>
            
            <li class="">
              
                <a href="https://appernetic.io/app/" >
                  
                  Dashboard
                </a>
              
            </li>
            
            
              
          </ul>
        </div>
        
      </div>
    </nav>
  </header>





<div class="container">
  <div class="row">
    <div class="col-sm-9">


      <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" >
<header class="container hat">
  <h1>Logging SSH logins to Slack
</h1>

</header>
</div>


      <div class="content">
  

<p>I&rsquo;m using <a href="http://vninja.net/homelab/homelabops-via-slack/">Slack to alert and log </a>a few things in my environment, and one of the things I use it for is to alert me if someone logs on via SSH to my public facing Jumphost.</p>

<p><em>For a good walkthrough on how to set up such a host, check out <a href="http://www.virtualtothecore.com/en/tunnel-all-your-remote-connections-through-ssh-with-a-linux-jumpbox/">Tunnel all your remote connections through ssh with a linux jumpbox</a> by <a href="https://twitter.com/dellock6">Luca Dell&rsquo;Oca</a>.</em></p>

<p>My Ubuntu 16.04 Jumphost is set up to only accept Key-Based Authentication, to secure it as much as possible, but I would still like to get instant notification if someone logs into it interactively.</p>

<h2 id="how-to-set-up-ssh-login-notification-to-slack">How to set up SSH login notification to Slack.</h2>

<ol>
<li><p><img src="http://vninja.net/wordpress/wp-content/uploads/2016/10/Screenshot-2016-10-06-13.04.51-300x182.png" alt="screenshot-2016-10-06-13-04-51" />First of all, we need  an Incoming WebHook in Slack in order to receive the notifications.
You configure those from the <strong>Apps &amp; Integration </strong>menu item. This in turn opens up the Slack App Directory, find <strong>Build</strong> on the top right and then choose <strong>Make a Custom Integration</strong>.</p></li>

<li><p><img src="http://vninja.net/wordpress/wp-content/uploads/2016/10/Screenshot-2016-10-06-13.08.09-300x60.png" alt="screenshot-2016-10-06-13-08-09" />One your are in the <strong>Build a Custom Integration </strong>section, find (or search) <strong>Incoming WebHooks</strong> and select that.</p></li>

<li><p>Next up, define which Slack channel should be the integration point, and click on <strong>Add Incoming WebHooks</strong> integration.</p></li>

<li><p>Copy the Webhook URL presented on the next screen
<strong>Note:</strong> keep this one a secret, anyone with access to this URL will be able to post to your Slack channel.</p></li>

<li><p>On my Ubuntu 16.04 Linux jumphost I&rsquo;ve created a small bash script called <em>/etc/ssh/notify.sh</em>. This script utilizes <em>curl </em> and the WebHook URL to post information directly to Slack. The script looks like this:<strong>notify.sh</strong>
[cc lang=&laquo;bash&raquo; escaped=&laquo;true&raquo;]
#!/bin/sh
url=&laquo;<a href="https://hooks.slack.com/services/*********&quot;">https://hooks.slack.com/services/*********&quot;</a>
channel=&laquo;#messages&raquo;
host=&raquo;<code>hostname</code>&laquo;
content=&raquo;\&laquo;attachments\&raquo;: [ { \&laquo;mrkdwn_in\&raquo;: [\&laquo;text\&laquo;, \&laquo;fallback\&laquo;], \&laquo;fallback\&raquo;: \&laquo;SSH login: $USER connected to `$host`\&laquo;, \&laquo;text\&raquo;: \&laquo;SSH login to `$host`\&laquo;, \&laquo;fields\&raquo;: [ { \&laquo;title\&raquo;: \&laquo;User\&laquo;, \&laquo;value\&raquo;: \&laquo;$USER\&laquo;, \&laquo;short\&raquo;: true }, { \&laquo;title\&raquo;: \&laquo;IP Address\&laquo;, \&laquo;value\&raquo;: \&laquo;$SSH_CLIENT\&laquo;, \&laquo;short\&raquo;: true } ], \&laquo;color\&raquo;: \&laquo;#F35A00\&raquo; } ]&raquo;
curl -s -X POST &ndash;data-urlencode &laquo;payload={\&laquo;channel\&raquo;: \&laquo;$channel\&laquo;, \&laquo;mrkdwn\&raquo;: true, \&laquo;username\&raquo;: \&laquo;ssh-bot\&laquo;, $content, \&laquo;icon_emoji\&raquo;: \&raquo;:computer:\&laquo;}&raquo; $url
/bin/bash
[/cc]Replace the  the WebHook URL with your own from step 4 and which channel to post to and you should be ready to go.  This script logs the username and the IP address the connection comes from, and then posts it to the Slack WebHook with the help of <em>curl</em>.<strong>Note:</strong> I&rsquo;ve chosen to include the WebHook name etc in the script itself, instead of via the WebHook definition on Slack, mostly since I don&rsquo;t want to create a WebHook for all hosts I want logging from. With this setup, I can just change the username part of the _curl _command. It already logs the hostname, so this is pretty much superficial, but hey, that&rsquo;s how I made it.</p></li>

<li><p><em>chmod +x /etc/ssh/notify.sh</em> to make it executable, and test it. If everything works as expected, you should see an immediate log entry in your chosen Slack channel.</p></li>

<li><p>On order to make this script runs every time someone logs into the Jumphost, I added a ForceCommand to the end of my_ /etc/ssh/sshd_config _file, like this:[cc lang=&laquo;bash&raquo; escaped=&laquo;true&raquo;]
ForceCommand /etc/ssh/notify.sh
[/cc]</p></li>
</ol>

<p>And that&rsquo;s it. A login via SSH on the Jumphost now looks like this in my Slack channel:</p>

<p><img src="http://vninja.net/wordpress/wp-content/uploads/2016/10/Screenshot-2016-10-06-13.26.10-1-1024x179.png" alt="screenshot-2016-10-06-13-26-10" /></p>

<p>How awesome is that? Of course, this just scratches the surface of what is possible with Slack&rsquo;s Incoming WebHooks, I&rsquo;m using a similar approach for logging new devices discovered in phpmyipam but that&rsquo;s for another post.</p>

</div>


      
    </div>
    
      <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
        <div>
  

    <div class="section">
      <header><div class="title"><b>Latest Posts</b></div></header>
      <div class="content">
        <ul>
        
        </ul>
      </div>
    </div>

    
      
      
      <div class="section taxonomies">
        <header><div class="title"><b>tag</b></div></header>

        <div class="content">
          <ul>
            <li><a href="/tags/vmware">vmware</a></li><li><a href="/tags/vsphere">vsphere</a></li><li><a href="/tags/vcenter">vcenter</a></li><li><a href="/tags/fun">fun</a></li><li><a href="/tags/ops">ops</a></li><li><a href="/tags/virtualization">virtualization</a></li><li><a href="/tags/esxi">esxi</a></li><li><a href="/tags/vmworld">vmworld</a></li><li><a href="/tags/news">news</a></li><li><a href="/tags/veeam">veeam</a></li>
          </ul>
        </div>
      </div>
      
    
      
      
    

</div>

      </div>
    
  </div>
</div>
    
<footer class="footer hidden-print">
  <div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="javascript:" id="return-to-top">back to top</a>
</div>
<div class="pull-right">

<a href="/disclaimer/">Disclaimer</a> <i>&middot;</i>

<a href="/terms/">Terms</a> 

</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
              
    
<div class="container footline">
    <small>
  code with <i class='fa fa-heart'></i>

</small>
</div>


    
<div class="container copyright">
    <small>
  &copy; 2016 Copyright my blog

  </small>
</div>



        </div>
    </div>
  </div>
</footer>

    

<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>


<script src="/js/highlight.pack.js"></script>
<script src="/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
  var _gaq=[['_setAccount','Your Google Analytics tracking code'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>

<script>
var ENABLE_POPOVER =  false , 
EXPIRE_COOKIE =  5 , 
SHOW_MODAL_TIMEOUT =  10000 , 
MOUSE_LEAVE =  true , 
MODAL_SIZE = "", 
POST_URL = "https://zapier.com/hooks/...", 
SIGNUP_HEADER = "Join Our Newsletter",
HEADER_IMAGE = "//placehold.it/1000x600",
IMG_DESCRIPTION = "Placeholder image for this popover modal optin form",
SIGNUP_TEXT = "Signup today for free and be the first to get notified on new updates.",
INPUT_PLACEHOLDER = "Enter your email",
SUBMIT_BUTTON = "Subscribe",
SUCCESS_MESSAGE = "Thanks for your subscription!",
ERROR_MESSAGE = "Submitting form failed!",
OPTIN =  true ,
COOKIE_NAME = "mycookie1",
CONTENTLANGUAGE = ""; 
</script>





<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax//MathJax.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax//config/TeX-AMS-MML_HTMLorMML.js"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    for(var all in MathJax.Hub.getAllJax()) {
        all.SourceElement().parentNode.className += ' has-jax';

    }
});
</script>






  </body>
</html>

