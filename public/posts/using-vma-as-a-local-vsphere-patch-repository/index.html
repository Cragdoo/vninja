<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Using vMA as a local vSphere Patch Repository" />
<meta property="og:description" content="I like using http as the transport protocol when patching my vSphere hosts. It&rsquo;s easy to use and in most cases immediately available over most networks. Since I want to use http as the transport, we need to make vMA work as a http server.
Starting Apache inside vMA Luckily, the Apache http daemon is installed, by default, in vMA and to utilize it all you have to do is to start it!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/using-vma-as-a-local-vsphere-patch-repository/" />



<meta property="article:published_time" content="2011-03-07T22:43:33&#43;00:00"/>

<meta property="article:modified_time" content="2011-03-07T22:43:33&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using vMA as a local vSphere Patch Repository"/>
<meta name="twitter:description" content="I like using http as the transport protocol when patching my vSphere hosts. It&rsquo;s easy to use and in most cases immediately available over most networks. Since I want to use http as the transport, we need to make vMA work as a http server.
Starting Apache inside vMA Luckily, the Apache http daemon is installed, by default, in vMA and to utilize it all you have to do is to start it!"/>
<meta name="generator" content="Hugo 0.40.3" />


    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Using vMA as a local vSphere Patch Repository",
  "url": "/posts/using-vma-as-a-local-vsphere-patch-repository/",
  "wordCount": "722",
  "datePublished": "2011-03-07T22:43:33&#43;00:00",
  "dateModified": "2011-03-07T22:43:33&#43;00:00",
  "author": {
    "@type": "Person",
    "name": "cmohn"
  },
  "keywords": "Howto, Virtualization, ESX, ESXi, Ops, vCLI, Virtual Appliance, vMA, VMware, vSphere"
}
</script>



    <link rel="canonical" href="/posts/using-vma-as-a-local-vsphere-patch-repository/">

    <title>Using vMA as a local vSphere Patch Repository | Adventures in Hugo</title>

    <!-- combined, minified CSS -->
    <link href="/css/style.css" rel="stylesheet" integrity="sha384-TbfEhJn4HkgPUIZUhhHaAYsycYKHxSuIloCjZOiyCSpbVunRQxg5T5pxKVFwxilF" crossorigin="anonymous">

    

    

    

    

  </head>

  <body>

    
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link " href="/">Home</a>
          
          <a class="nav-link" href="https://example.org" title="">Link 1</a>
          
        </nav>
      </div>
    </div>
    

    
    <header class="blog-header">
      <div class="container">
        <h1 class="blog-title"><a href="/" rel="home">Adventures in Hugo</a></h1>
        <p class="lead blog-description">There is a thin line between agile and fragile</p>
      </div>
    </header>
    

    
    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">

          


<article class="blog-post">
  <header>
    <h2 class="blog-post-title"><a href="/posts/using-vma-as-a-local-vsphere-patch-repository/">Using vMA as a local vSphere Patch Repository</a></h2>
    <p class="blog-post-meta"><time datetime="2011-03-07T22:43:33Z">Mon Mar 07, 2011</time> by cmohn in 
<i class="fa fa-folder" aria-hidden="true"></i>&nbsp;<a href="/categories/howto" rel="category tag">Howto</a>, <a href="/categories/virtualization" rel="category tag">Virtualization</a>


<i class="fa fa-tag" aria-hidden="true"></i>&nbsp;<a href="/tags/esx" rel="tag">ESX</a>, <a href="/tags/esxi" rel="tag">ESXi</a>, <a href="/tags/ops" rel="tag">Ops</a>, <a href="/tags/vcli" rel="tag">vCLI</a>, <a href="/tags/virtual-appliance" rel="tag">Virtual Appliance</a>, <a href="/tags/vma" rel="tag">vMA</a>, <a href="/tags/vmware" rel="tag">VMware</a>, <a href="/tags/vsphere" rel="tag">vSphere</a>

</p>
  </header>
  

<p>I like using http as the transport protocol when patching my vSphere hosts. It&rsquo;s easy to use and in most cases immediately available over most networks. Since I want to use http as the transport, we need to make vMA work as a http server.</p>

<h3 id="starting-apache-inside-vma">Starting Apache inside vMA</h3>

<p>Luckily, the <a href="http://www.apache.org/">Apache http daemon</a> is installed, by default, in vMA and to utilize it all you have to do is to start it!</p>

<p>Log on to vMA with your favorite SSH client and run the following command to start the Apache HTTP Daemon:</p>

<pre><code>[vi-admin@vMA /]$ sudo service httpd start
Starting httpd: httpd: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for  ServerName                   [ OK ]
[vi-admin@vMA /]$
</code></pre>

<p>Never mind the error message it displays, for our purposes that&rsquo;s not an issue and we can safely ignore it.</p>

<p>By default the files served by Apache is located in <em>/var/www/html</em>, so we&rsquo;ll head over there to create a new directory</p>

<pre><code>[vi-admin@vMA /]$ cd /var/www/html/
[vi-admin@vMA html]$ sudo mkdir repo
</code></pre>

<p>We&rsquo;ve now created the repo directory inside the Apache docroot. Now we need to add some patches to that directory, to make  it available for the <em>vihostupdate</em> or <em>esxupdate</em> command we can use to patch our hosts.</p>

<p>In my lab, I used the <strong>update-from-esxi4.1-4.1_update01</strong> patch bundle from <a href="https://hostupdate.vmware.com/software/VUM/OFFLINE/release-260-20110127-912579/update-from-esxi4.1-4.1_update01.zip">vmware.com</a></p>

<p>To download the patch into the new repo directory created above, run the following commands:</p>

<pre><code>[vi-admin@vMA html]$ cd /var/www/html/repo/
[vi-admin@vMA repo]$ sudo wget https://hostupdate.vmware.com/software/VUM/OFFLINE/release-260-20110127-912579/update-from-esxi4.1-4.1_update01.zip
Password:
--15:34:32--  https://hostupdate.vmware.com/software/VUM/OFFLINE/release-260-20110127-912579/update-from-esxi4.1-4.1_update01.zip
    Resolving hostupdate.vmware.com... 88.221.164.7
    Connecting to hostupdate.vmware.com|88.221.164.7|:443... connected.
    HTTP request sent, awaiting response... 200 OK
    Length: 215820281 (206M) [application/zip]
    Saving to: `update-from-esxi4.1-4.1_update01.zip'
100%[===============================================================================================================&gt;] 

215,820,281  919K/s   in 3m 54s
15:38:26 (901 KB/s) - `update-from-esxi4.1-4.1_update01.zip' saved [215820281/215820281]
</code></pre>

<p>This downloads the patch bundle, using the wget command, to the current directory.</p>

<p>Now, to make sure your downloaded patch bundle is available via the web server, open <strong><a href="http://vMA-IP/repo/">http://vMA-IP/repo/</a></strong> and you should see the directory contents listed. Your browser should display something similar to this:</p>

<p><img src="http://vninja.net/wordpress/wp-content/uploads/2011/03/vMA-Patch-1-300x117.png" alt="" /></p>

<p>Before patching a host, power off or migrate any virtual machines that are running on the host and place the host into maintenance mode.</p>

<h4 id="scan-host-for-update-compatibility">Scan host for update compatibility</h4>

<pre><code>[vi-admin@vMA repo]$ vihostupdate --server 10.0.100.20 --scan --bundle http://10.0.101.14/repo/update-from-esxi4.1-4.1_update01.zip
Enter username: root
Enter password:
The bulletins which apply to but are not yet installed on this ESX host are listed.

---------Bulletin ID---------   ----------------Summary-----------------
ESXi410-201101201-SG            Updates the ESXi 4.1 firmware
ESXi410-201101202-UG            Updates the ESXi  4.1 VMware Tools
ESXi410-201101223-UG            3w-9xxx: scsi driver for VMware ESXi
ESXi410-201101224-UG            vxge: net driver for VMware ESXi
ESXi410-Update01                VMware ESXi 4.1 Complete Update 1
</code></pre>

<h4 id="install-updates-to-host">Install updates to host</h4>

<pre><code>[vi-admin@vMA repo]$ vihostupdate --server 10.0.100.20 --install --bundle http://10.0.101.14/repo/update-from-esxi4.1-4.1_update01.zip
Enter username: root
Enter password:
Please wait patch installation is in progress ...
The update completed successfully, but the system needs to be rebooted for the changes to be effective.
[vi-admin@vMA repo]$
</code></pre>

<p>While the update runs, you can also follow it&rsquo;s progress in the vSphere Client</p>

<p><a href="http://vninja.net/wordpress/wp-content/uploads/2011/03/vMA-Patch-2.png"><img src="http://vninja.net/wordpress/wp-content/uploads/2011/03/vMA-Patch-2-300x247.png" alt="" /></a>
When the patch has completed, and the host has been rebooted you can run the scan command again to make sure all of the patches are installed and no longer required.</p>

<h4 id="management">Management</h4>

<p>Now, downloading the patches this way for each vMA instance you have (especially if you have several remote sites) is not very effective. Sure, you could place a central repository at a central site and use that as your central update repository. In that scenario you might as well just use the VMware vCenter Update Manager and not have to manage your updates via vMA at all.</p>

<p>In some cases though, you would want to have the remote hosts install their updates from a local repository. One such case might be if you have remote locations with low bandwidth/high latency links that you don&rsquo;t want to stress with the update downloads.</p>

<p><em>I&rsquo;m investigating a possible solution for that as well, and I&rsquo;ll post that as soon as I have working proof of concept up and running.</em></p>

<p>Another thing to note, is that when you restart vMA the http service will be stopped again. If you want it to autostart each time vMA boots, issue the following command</p>

<pre><code>[vi-admin@vMA repo]$ sudo ntsysv
Password:
</code></pre>

<p>This brings up a screen where you can choose which daemons should start at boot time inside of vMA.</p>

<p><a href="http://vninja.net/wordpress/wp-content/uploads/2011/03/vMA-Patch-3.png"><img src="http://vninja.net/wordpress/wp-content/uploads/2011/03/vMA-Patch-3-300x198.png" alt="" /></a></p>

<p>Find <em>httpd</em>, select it and hit the OK button. The next time vMA boots, the Apache web server starts with it.</p>


  

  
  <hr>
  <footer>

  
    <section>
    <h4>Share</h4>
    <nav class="nav sharing-icons">
      <a class="nav-item" href="https://www.facebook.com/sharer/sharer.php?u=%2fposts%2fusing-vma-as-a-local-vsphere-patch-repository%2f" title="Share on Facebook"><span class="fa fa-facebook fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://plus.google.com/share?url=%2fposts%2fusing-vma-as-a-local-vsphere-patch-repository%2f" title="Share on Google+"><span class="fa fa-google-plus fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fposts%2fusing-vma-as-a-local-vsphere-patch-repository%2f" title="Share on LinkedIn"><span class="fa fa-linkedin fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://twitter.com/home?status=%2fposts%2fusing-vma-as-a-local-vsphere-patch-repository%2f" title="Tweet this"><span class="fa fa-twitter fa-2x"></span></a>
    </nav>
  </section>

  

  
  </footer>
  

</article> 



        </div> <!-- /.blog-main -->

        <aside class="col-sm-3 ml-auto blog-sidebar">
  

  

  
  <section class="sidebar-module">
    <h4>Links</h4>
    <ol class="list-unstyled">
      
      <li><a href="https://example.com">Link 1</a></li>
      
      <li><a href="https://example.org">Link 2</a></li>
      
    </ol>
  </section>
  
</aside>


      </div> <!-- /.row -->
    </div> <!-- /.container -->
    

    
    <footer class="blog-footer">
      <p>
      
      &copy; Christian Mohn
      
      </p>
      <p>
      <a href="#">Back to top</a>
      </p>
    </footer>
    

  </body>

</html>
